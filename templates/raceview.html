{% extends "layout.html" %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/raceview.css') }}">
{% endblock %}

{% block content %}
<main>
    <button id="return-button"><a href="{{ url_for('index') }}">
            <p>Return</p>
        </a></button>

    <script>
        let currentInterval; // Declare outside to clear it properly

        function fetchCoordinates(currentTime) {
            console.log("Current time: " + currentTime);
            const url = '/get-coordinates?currentTime=' + currentTime;
            let currentDateTime = new Date(currentTime); // Declare as local

            clearInterval(currentInterval); // Clear existing interval
            fetch(url)
                .then(response => response.json())
                .then(coordinates => {
                    const test = document.getElementById("test-driver");
                    let coordinateIndex = 0;
                    const scaleFactor = 20;
                    const timeInterval = 100;

                    raceTrack = document.getElementById("race-track")
                    const trackWidth = raceTrack.offsetWidth;
                    const trackHeight = raceTrack.offsetHeight;

                    currentInterval = setInterval(() => {
                        if (coordinateIndex < coordinates.length) {
                            const x = coordinates[coordinateIndex][0] / scaleFactor;
                            const y = coordinates[coordinateIndex][1] / scaleFactor;
                           
                            test.style.left = (trackWidth / 2 + x - test.offsetWidth / 2) + 'px';
                            test.style.top = (trackHeight / 2 + y - test.offsetHeight / 2) + 'px';
                            
                            coordinateIndex++;
                        
                        } else {
                            clearInterval(currentInterval); // Stop the interval when coordinates are exhausted
                            currentDateTime.setSeconds(currentDateTime.getSeconds() + 10);
                            fetchCoordinates(formatDate(currentDateTime)); // Call recursively with new time
                        }
                    }, timeInterval);
                })
                .catch(error => {
                    console.error('Error fetching coordinates:', error);
                    clearInterval(currentInterval); // Clear on error
                });
            
        }
        function formatDate(date) {
        // Utility function to format date to string
            return date.getFullYear() + '-' +
            ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
            ('0' + date.getDate()).slice(-2) + 'T' +
            ('0' + date.getHours()).slice(-2) + ':' +
            ('0' + date.getMinutes()).slice(-2) + ':' +
            ('0' + date.getSeconds()).slice(-2);
        }
    </script>
    <div id="race-track">
        <div id="test-driver"></div>
    </div>

    <div id="buttonDiv">
        <button class="nextPreviousButtons" name="next" onclick="movebackwards()">-</button>
        <button class="nextPreviousButtons" name="previous" onclick="fetchCoordinates('2023-03-05T16:00:00')">+</button>
    </div>

</main>
{% endblock %}