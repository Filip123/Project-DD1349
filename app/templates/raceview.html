{% extends "layout.html" %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/raceview.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/layout.css') }}">
{% endblock %}

{% block content %}
<main>
    <div id="driverStandings">
        <ol>
            <li>Verstappen</li>
            <li>Norris!!</li>
        </ol>
    </div>
    <div id="middleContainer">
        <div id="infoBar">
            <a href="{{ url_for('index') }}">
                <i class="fa-solid fa-arrow-left fa-xl"></i>
            </a></button>
            <div class="infoBarItem">Singapore</div>
            <div class="infoBarItem">Lap 5/57</div>
            <div class="infoBarItem">Time: 15:30:07</div>   
        </div>
        <div id="buttonDiv">
            <button class ="nextPreviousButtons" name="next" onclick="movebackwards()">-</button>
            <button class ="nextPreviousButtons" name="previous" onclick="fetchCoordinates('2023-09-17T13:00:00', 0)">Start</button>
        </div>
        <div id="raceTrack">
            <div id="testDriver"></div>         
        </div>
        <div id="timeControlSlideContainer">
            
            <input type="range" min="0" max="720" value="0" id="timeSliderInput" onchange="fetchCoordinates('2023-09-17T13:00:00', this.value)">
            <label for="timeSliderInput">Time Control</label>
            <p id="time"></p>
            
        </div>
    </div>
    <div id="filterContainer">
        <form>
            -> Filter <br>
            <!--Ladda in befintliga förare i specifika racet här -->
            <input type="checkbox" id="driver1" name="driver1" checked > 
            <label for="vehicle1"> Verstappen </label><br>
            <input type="checkbox" id="driver2" name="driver2" checked >
            <label for="vehicle2"> Sainz</label><br>
            <input type="checkbox" id="driver3" name="driver3" checked >
            <label for="vehicle3"> Bottas </label><br>
        </form>
    </div>

    <script>
        let currentInterval; // Declare outside to clear it properly
        let isFetching = false; // To track if a fetch request is ongoing
        let debounceTimeout; // To handle debouncing

        function fetchCoordinates(baseTime, slideValue) {
            if (isFetching) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => fetchCoordinates(baseTime, slideValue), 200);
                return;
            }

            isFetching = true;
            let startTime = new Date(baseTime);
            startTime.setSeconds(startTime.getSeconds() + parseInt(slideValue) * 10); // Adjusting time based on slider value
            let formattedTime = formatDate(startTime);

            console.log("Current time: " + formattedTime);
            const url = '/get-coordinates?currentTime=' + formattedTime;

            document.getElementById('time').innerHTML = startTime;

            clearInterval(currentInterval); // Clear existing interval
            fetch(url)
                .then(response => response.json())
                .then(coordinates => {
                    const testDriver = document.getElementById("testDriver");
                    const raceTrack = document.getElementById("raceTrack");
                    let coordinateIndex = 0;
                    const scaleFactor = 30;
                    const timeInterval = 100;

                    currentInterval = setInterval(() => {
                        if (coordinateIndex < coordinates.length) {
                            const x = coordinates[coordinateIndex][0] / scaleFactor;
                            const y = coordinates[coordinateIndex][1] / scaleFactor;
                            testDriver.style.left = `${100 + (raceTrack.offsetWidth / 2 + x - testDriver.offsetWidth / 2) + 250}px`;
                            testDriver.style.bottom = `${(raceTrack.offsetHeight / 2 + y - testDriver.offsetHeight / 2) + 100}px`;
                            coordinateIndex++;
                        } else {
                            clearInterval(currentInterval);
                            let slider = document.getElementById("timeSliderInput");
                            let newValue = parseInt(slider.value) + 1;
                            if (newValue <= slider.max) {
                                slider.value = newValue; // Update slider value
                                fetchCoordinates(baseTime, newValue); // Fetch next set of coordinates automatically if needed
                            }
                        }
                    }, timeInterval);
                    isFetching = false;
                })
                .catch(error => {
                    console.error('Error fetching coordinates:', error);
                    clearInterval(currentInterval);
                    isFetching = false;
                });
        }

        function formatDate(date) {
            // Utility function to format date to string
            return date.getFullYear() + '-' +
                ('0' + (date.getMonth() + 1)).slice(-2) + '-' +
                ('0' + date.getDate()).slice(-2) + 'T' +
                ('0' + date.getHours()).slice(-2) + ':' +
                ('0' + date.getMinutes()).slice(-2) + ':' +
                ('0' + date.getSeconds()).slice(-2);
        }
    </script>
</main>
{% endblock %}
